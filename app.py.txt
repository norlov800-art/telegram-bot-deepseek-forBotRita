import os
import telebot
import requests
import logging
from flask import Flask, request

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.DEBUG)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TELEGRAM_TOKEN = os.environ.get('8504373078:AAEINBhCSq7yBC42A5Ucf14Z-UmK95WEqXI')
DEEPSEEK_API_KEY = os.environ.get('sk-3baac25d30784da9acb6d5c9a067bc8b')

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
if not TELEGRAM_TOKEN:
    print("‚ùå TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
if not DEEPSEEK_API_KEY:
    print("‚ö†Ô∏è DEEPSEEK_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω, –±–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —ç—Ö–æ-—Ä–µ–∂–∏–º–µ")

bot = telebot.TeleBot(TELEGRAM_TOKEN)
app = Flask(__name__)

@app.route('/')
def home():
    return "‚úÖ Telegram Bot is running! Use /start command"

@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return ''
    return 'Bad request', 403

@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ä–∞–±–æ—Ç–∞—é—â–∏–π –±–æ—Ç. –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã!")

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    try:
        # –ï—Å–ª–∏ –µ—Å—Ç—å API –∫–ª—é—á DeepSeek
        if DEEPSEEK_API_KEY:
            headers = {"Authorization": f"Bearer {sk-3baac25d30784da9acb6d5c9a067bc8b}"}
            data = {
                "model": "deepseek-chat",
                "messages": [{"role": "user", "content": message.text}]
            }
            response = requests.post(
                "https://api.deepseek.com/chat/completions",
                json=data,
                headers=headers,
                timeout=10
            )
            answer = response.json()["choices"][0]["message"]["content"]
            bot.reply_to(message, answer[:4000])
        else:
            # –≠—Ö–æ-—Ä–µ–∂–∏–º –µ—Å–ª–∏ –Ω–µ—Ç API –∫–ª—é—á–∞
            bot.reply_to(message, f"–í—ã —Å–∫–∞–∑–∞–ª–∏: {message.text}")
    except Exception as e:
        bot.reply_to(message, f"–û—à–∏–±–∫–∞: {str(e)[:200]}")

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port)
